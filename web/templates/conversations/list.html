{% extends "base.html" %}

{% block title %}Conversas - BOT by YLADA{% endblock %}

{% block extra_styles %}
        .page-header {
            background: white;
            border-radius: 12px;
            padding: 25px 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
            border: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .page-header h1 {
            margin: 0;
            color: #333;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: 10px;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-secondary {
            background: #6b7280;
        }
        
        .conversations-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            height: calc(100vh - 180px);
        }
        
        .conversations-list {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.08);
            border: 1px solid #e5e7eb;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        #conversationsList {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .conversation-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 8px;
            margin-bottom: 5px;
        }
        
        .conversation-item:hover {
            background: #f9fafb;
        }
        
        .conversation-item.active {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
        }
        
        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 5px;
        }
        
        .conversation-name {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }
        
        .conversation-time {
            font-size: 12px;
            color: #999;
        }
        
        
        .unread-badge {
            background: #3b82f6;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .messages-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.08);
            border: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        .messages-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: white;
            position: sticky;
            top: 0;
            z-index: 10;
            flex-shrink: 0;
        }
        
        .messages-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            min-height: 0;
        }
        
        .message-item {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .message-item.sent {
            align-items: flex-end;
        }
        
        .message-item.received {
            align-items: flex-start;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.4;
        }
        
        .message-bubble strong {
            font-weight: 600;
        }
        
        .message-item.sent .message-bubble {
            background: #3b82f6;
            color: white;
        }
        
        .message-item.received .message-bubble {
            background: #f3f4f6;
            color: #333;
        }
        
        /* Estilos para m√≠dias estilo WhatsApp */
        .message-media {
            margin: 8px 0;
            border-radius: 8px;
            overflow: hidden;
            max-width: 100%;
        }
        
        .message-image {
            max-width: 100%;
            max-height: 400px;
            width: auto;
            height: auto;
            border-radius: 8px;
            cursor: pointer;
            display: block;
            object-fit: contain;
        }
        
        .message-image:hover {
            opacity: 0.9;
        }
        
        .message-audio {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        
        .message-item.received .message-audio {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .audio-player {
            flex: 1;
            min-width: 0;
        }
        
        .audio-player audio {
            width: 100%;
            height: 40px;
            outline: none;
        }
        
        .audio-icon {
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .message-caption {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 14px;
            line-height: 1.4;
        }
        
        .message-item.received .message-caption {
            border-top-color: rgba(0, 0, 0, 0.1);
        }
        
        /* Modal para visualizar imagem em tamanho maior */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            cursor: pointer;
        }
        
        .image-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        
        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
        }
        
        .image-modal-close:hover {
            opacity: 0.7;
        }
        
        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .message-input-container {
            border-top: 1px solid #e5e7eb;
            padding: 15px;
            background: white;
        }
        
        .message-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 20px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            max-height: 120px;
            overflow-y: auto;
            transition: border-color 0.2s;
        }
        
        .message-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .btn-send {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .btn-send:hover {
            background: #2563eb;
            transform: scale(1.05);
        }
        
        .btn-send:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .flow-status {
            margin-top: 10px;
            padding: 8px;
            background: #f0f9ff;
            border-radius: 8px;
            color: #0369a1;
            font-size: 12px;
        }
        
        .search-box {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
            transition: border-color 0.2s;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .search-box {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            width: 100%;
            font-size: 14px;
        }
        
        .filters-container {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            flex: 1;
            min-width: 100px;
            padding: 10px 15px;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #4b5563;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        
        .filter-btn:hover {
            background: #e5e7eb;
            border-color: #d1d5db;
        }
        
        .filter-btn.active {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #1e40af;
            font-weight: 600;
        }
        
        .filter-count {
            background: #d1d5db;
            color: #4b5563;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }
        
        .filter-btn.active .filter-count {
            background: #3b82f6;
            color: white;
        }
        
        .filter-btn[data-filter="unread"] .filter-count {
            background: #fef3c7;
            color: #92400e;
        }
        
        .filter-btn.active[data-filter="unread"] .filter-count {
            background: #f59e0b;
            color: white;
        }
{% endblock %}

{% block content %}
    <div class="page-header">
        <h1>üí¨ Conversas</h1>
        <div>
            <button onclick="loadConversations()" class="btn">Atualizar</button>
        </div>
    </div>
        
        <div class="conversations-container">
            <div class="conversations-list">
                <!-- Filtros -->
                <div class="filters-container">
                    <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">
                        <span>Todas</span>
                        <span class="filter-count" id="countAll">0</span>
                    </button>
                    <button class="filter-btn" data-filter="unread" onclick="setFilter('unread')">
                        <span>N√£o Lidas</span>
                        <span class="filter-count" id="countUnread">0</span>
                    </button>
                    <button class="filter-btn" data-filter="individuals" onclick="setFilter('individuals')">
                        <span>Individuais</span>
                        <span class="filter-count" id="countIndividuals">0</span>
                    </button>
                    <button class="filter-btn" data-filter="groups" onclick="setFilter('groups')">
                        <span>Grupos</span>
                        <span class="filter-count" id="countGroups">0</span>
                    </button>
                </div>
                
                <!-- Busca -->
                <input type="text" class="search-box" id="searchInput" placeholder="üîç Buscar conversas..." onkeyup="filterConversations()">
                
                <!-- Lista -->
                <div id="conversationsList">
                    <div class="loading">Carregando conversas...</div>
                </div>
            </div>
            
            <div class="messages-container">
                <div class="messages-header" id="messagesHeader">
                    <h3 style="color: #666; margin: 0;">Selecione uma conversa</h3>
                </div>
                <div class="messages-list" id="messagesList">
                    <div class="empty-state">
                        <h3>üí¨ Selecione uma conversa</h3>
                        <p>Escolha uma conversa da lista ao lado para ver as mensagens</p>
                    </div>
                </div>
                
                <!-- Modal para visualizar imagem em tamanho maior -->
                <div class="image-modal" id="imageModal" onclick="closeImageModal()">
                    <span class="image-modal-close">&times;</span>
                    <img id="modalImage" src="" alt="Imagem ampliada">
                </div>
                <!-- Campo de envio de mensagem -->
                <div class="message-input-container" id="messageInputContainer" style="display: none;">
                    <div class="message-input-wrapper">
                        <textarea 
                            id="messageInput" 
                            class="message-input" 
                            placeholder="Digite sua mensagem..."
                            rows="1"
                            onkeydown="handleMessageKeyDown(event)"
                        ></textarea>
                        <button onclick="sendMessage()" class="btn-send" id="sendButton">
                            <span>‚û§</span>
                        </button>
                    </div>
                    <div class="flow-status" id="flowStatus" style="display: none;">
                        <small>ü§ñ Fluxo ativo: <span id="activeFlowName">-</span></small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let conversations = [];
        let selectedChatId = null;
        let currentFilter = 'all'; // all, unread, individuals, groups
        let currentInstanceId = null;
        
        // Busca inst√¢ncia do usu√°rio antes de carregar conversas
        async function getCurrentInstance() {
            try {
                const response = await fetch('/api/instances');
                const data = await response.json();
                if (data.success && data.instances && data.instances.length > 0) {
                    return data.instances[0].id;
                }
            } catch (error) {
                console.error('Erro ao buscar inst√¢ncia:', error);
            }
            return null;
        }
        
        async function loadConversations() {
            // Mostra loading
            document.getElementById('conversationsList').innerHTML = '<div class="loading">Carregando conversas...</div>';
            
            // Obt√©m instance_id se ainda n√£o tiver
            if (!currentInstanceId) {
                currentInstanceId = await getCurrentInstance();
            }
            
            // Monta URL com instance_id se dispon√≠vel
            const url = currentInstanceId ? `/api/conversations?instance_id=${currentInstanceId}` : '/api/conversations';
            
            fetch(url)
                .then(r => {
                    if (!r.ok) {
                        // Tenta obter mensagem de erro do JSON
                        return r.json().then(errData => {
                            throw new Error(errData.error || errData.details || `HTTP ${r.status}: ${r.statusText}`);
                        }).catch(() => {
                            throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                        });
                    }
                    return r.json();
                })
                .then(data => {
                    console.log('Dados recebidos:', data);
                    
                    // Tenta diferentes formatos de resposta
                    let chats = [];
                    if (data.success && data.chats) {
                        chats = data.chats;
                    } else if (Array.isArray(data)) {
                        chats = data;
                    } else if (data.chats) {
                        chats = data.chats;
                    }
                    
                    if (chats && chats.length > 0) {
                        conversations = chats;
                        updateFilterCounts(conversations);
                        applyFilters();
                    } else {
                        document.getElementById('conversationsList').innerHTML = `
                            <div class="empty-state">
                                <h3>üì≠ Nenhuma conversa encontrada</h3>
                                <p>As conversas aparecer√£o aqui quando voc√™ receber mensagens</p>
                                <p style="margin-top: 10px; font-size: 12px; color: #666;">
                                    üí° <strong>Dica:</strong> Envie uma mensagem do seu celular para testar!
                                </p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar conversas:', error);
                    let errorMessage = error.message || 'Erro desconhecido';
                    // Se a mensagem cont√©m "HTTP 500", adiciona mais contexto
                    if (errorMessage.includes('HTTP 500')) {
                        errorMessage = 'Erro interno do servidor. Verifique se o WhatsApp est√° conectado e tente novamente.';
                    } else if (errorMessage.includes('HTTP 503')) {
                        errorMessage = 'Servidor WhatsApp n√£o est√° acess√≠vel. Verifique se o servi√ßo est√° rodando.';
                    } else if (errorMessage.includes('HTTP 400')) {
                        errorMessage = 'WhatsApp n√£o est√° conectado. Conecte o WhatsApp primeiro.';
                    }
                    document.getElementById('conversationsList').innerHTML = `
                        <div class="empty-state">
                            <h3>‚ùå Erro ao carregar conversas</h3>
                            <p style="color: #dc2626; font-weight: 500;">${errorMessage}</p>
                            <p style="margin-top: 10px; font-size: 12px; color: #666;">Verifique se o WhatsApp est√° conectado na p√°gina "Conectar WhatsApp"</p>
                            <button onclick="loadConversations()" class="btn" style="margin-top: 10px;">üîÑ Tentar Novamente</button>
                        </div>
                    `;
                });
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Atualiza contadores dos filtros
        function updateFilterCounts(convs) {
            const all = convs.length;
            const unread = convs.filter(c => c.unreadCount > 0).length;
            const individuals = convs.filter(c => !c.isGroup).length;
            const groups = convs.filter(c => c.isGroup).length;
            
            document.getElementById('countAll').textContent = all;
            document.getElementById('countUnread').textContent = unread;
            document.getElementById('countIndividuals').textContent = individuals;
            document.getElementById('countGroups').textContent = groups;
        }
        
        // Aplica filtros ativos
        function applyFilters() {
            let filtered = [...conversations];
            
            // Aplica filtro selecionado
            switch(currentFilter) {
                case 'unread':
                    filtered = filtered.filter(c => c.unreadCount > 0);
                    break;
                case 'individuals':
                    filtered = filtered.filter(c => !c.isGroup);
                    break;
                case 'groups':
                    filtered = filtered.filter(c => c.isGroup);
                    break;
                case 'all':
                default:
                    // Mostra todas
                    break;
            }
            
            // Aplica busca se houver
            const search = document.getElementById('searchInput').value.toLowerCase();
            if (search) {
                filtered = filtered.filter(conv => 
                    conv.name.toLowerCase().includes(search) ||
                    conv.phone.includes(search) ||
                    (conv.lastMessage && conv.lastMessage.toLowerCase().includes(search))
                );
            }
            
            renderConversations(filtered);
        }
        
        // Define filtro ativo
        function setFilter(filter) {
            currentFilter = filter;
            
            // Atualiza bot√µes
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.filter-btn[data-filter="${filter}"]`).classList.add('active');
            
            // Aplica filtros
            applyFilters();
        }
        
        function renderConversations(convs) {
            const list = document.getElementById('conversationsList');
            
            if (convs.length === 0) {
                let message = '';
                if (currentFilter === 'unread') {
                    message = 'Nenhuma conversa n√£o lida';
                } else if (currentFilter === 'groups') {
                    message = 'Nenhum grupo encontrado';
                } else if (currentFilter === 'individuals') {
                    message = 'Nenhuma conversa individual encontrada';
                } else {
                    message = 'Nenhuma conversa encontrada';
                }
                
                list.innerHTML = `
                    <div class="empty-state">
                        <h3>üì≠ ${message}</h3>
                        <p style="margin-top: 10px; font-size: 14px; color: #666;">
                            ${currentFilter === 'all' ? 'üí° <strong>Dica:</strong> Envie uma mensagem do seu celular para testar o bot!' : 'Tente outro filtro ou limpe a busca.'}
                        </p>
                    </div>
                `;
                return;
            }
            
            // Separa individuais e grupos
            const individualChats = convs.filter(c => !c.isGroup);
            const groupChats = convs.filter(c => c.isGroup);
            
            let html = '';
            
            // Mostra conversas individuais primeiro (se n√£o estiver filtrando apenas grupos)
            if (individualChats.length > 0 && currentFilter !== 'groups') {
                html += individualChats.map(conv => {
                    const date = new Date(conv.timestamp);
                    const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    const isActive = selectedChatId === conv.id;
                    const preview = conv.lastMessage || '';
                    const previewText = preview.length > 50 ? preview.substring(0, 50) + '...' : preview;
                    
                    return `
                        <div class="conversation-item ${isActive ? 'active' : ''}" onclick="selectConversation('${conv.id}', '${escapeHtml(conv.name).replace(/'/g, "\\'")}', '${conv.phone}')">
                            <div class="conversation-header">
                                <div>
                                    <span class="conversation-name">${escapeHtml(conv.name)}</span>
                                    ${conv.unreadCount > 0 ? `<span class="unread-badge">${conv.unreadCount}</span>` : ''}
                                </div>
                                <span class="conversation-time">${timeStr}</span>
                            </div>
                            ${previewText ? `<div class="conversation-preview">${escapeHtml(previewText)}</div>` : ''}
                        </div>
                    `;
                }).join('');
            }
            
            // Mostra grupos depois (se n√£o estiver filtrando apenas individuais)
            if (groupChats.length > 0 && currentFilter !== 'individuals') {
                if (individualChats.length > 0 && currentFilter === 'all') {
                    html += '<div style="padding: 10px; font-weight: bold; color: #666; border-top: 1px solid #e5e7eb; margin-top: 10px;">Grupos</div>';
                }
                html += groupChats.map(conv => {
                    const date = new Date(conv.timestamp);
                    const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    const isActive = selectedChatId === conv.id;
                    
                    return `
                        <div class="conversation-item ${isActive ? 'active' : ''}" onclick="selectConversation('${conv.id}', '${escapeHtml(conv.name).replace(/'/g, "\\'")}', '${conv.phone}')">
                            <div class="conversation-header">
                                <div>
                                    <span class="conversation-name">üë• ${escapeHtml(conv.name)}</span>
                                    ${conv.unreadCount > 0 ? `<span class="unread-badge">${conv.unreadCount}</span>` : ''}
                                </div>
                                <span class="conversation-time">${timeStr}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            list.innerHTML = html;
        }
        
        function formatPreview(text) {
            if (!text) return '';
            
            // Detecta e formata vCard no preview
            if (text.includes('BEGIN:VCARD') || text.includes('VERSION:3.0')) {
                try {
                    // Tenta extrair nome
                    const fnMatch = text.match(/FN:([^\n\r;]+)/);
                    const nMatch = text.match(/N:([^\n\r;]+)/);
                    const name = fnMatch ? fnMatch[1].trim() : (nMatch ? nMatch[1].split(';')[0].trim() : 'Contato');
                    return `üë§ ${name}`;
                } catch (e) {
                    return 'üë§ Contato compartilhado';
                }
            }
            
            // Limita tamanho
            if (text.length > 50) {
                return text.substring(0, 50) + '...';
            }
            
            return text;
        }
        
        function filterConversations() {
            // Aplica busca junto com filtro ativo
            applyFilters();
        }
        
        let selectedChatPhone = null;
        let selectedChatName = null;
        
        function selectConversation(chatId, name, phone) {
            selectedChatId = chatId;
            selectedChatPhone = phone;
            selectedChatName = name;
            
            loadConversations(); // Re-renderiza para destacar a selecionada
            
            document.getElementById('messagesHeader').innerHTML = `
                <h3 style="margin: 0; color: #333;">${escapeHtml(name)}</h3>
                <p style="color: #999; font-size: 14px; margin-top: 5px; margin-bottom: 0;">${escapeHtml(phone)}</p>
            `;
            
            // Mostra campo de input
            document.getElementById('messageInputContainer').style.display = 'block';
            
            // Limpa input
            document.getElementById('messageInput').value = '';
            
            // Verifica se h√° fluxo ativo
            checkActiveFlow(phone);
            
            loadMessages(chatId);
        }
        
        function loadMessages(chatId) {
            const messagesList = document.getElementById('messagesList');
            messagesList.innerHTML = '<div class="loading">Carregando mensagens...</div>';
            
            fetch(`/api/conversations/${chatId}/messages?limit=50`)
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.messages) {
                        renderMessages(data.messages);
                    } else {
                        messagesList.innerHTML = `
                            <div class="empty-state">
                                <h3>‚ùå Erro ao carregar mensagens</h3>
                                <p>${data.error || 'Erro desconhecido'}</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar mensagens:', error);
                    messagesList.innerHTML = `
                        <div class="empty-state">
                            <h3>‚ùå Erro ao carregar mensagens</h3>
                            <p>${error.message}</p>
                        </div>
                    `;
                });
        }
        
        function formatMessageBody(msg) {
            // Verifica tipo de mensagem primeiro
            if (msg.type === 'image' || (msg.hasMedia && msg.type === 'image')) {
                // Retorna HTML para exibir imagem
                const mediaUrl = getMediaUrl(msg);
                if (mediaUrl) {
                    let html = `<div class="message-media">
                        <img src="${escapeHtml(mediaUrl)}" alt="Imagem" class="message-image" onclick="openImageModal('${escapeHtml(mediaUrl)}')" loading="lazy">
                    </div>`;
                    // Se tem legenda (body), adiciona
                    if (msg.body && msg.body.trim()) {
                        html += `<div class="message-caption">${escapeHtml(msg.body)}</div>`;
                    }
                    return html;
                }
                return 'üì∑ Imagem';
            }
            if (msg.type === 'video') {
                const mediaUrl = getMediaUrl(msg);
                if (mediaUrl) {
                    let html = `<div class="message-media">
                        <video controls class="message-image" style="max-height: 400px;">
                            <source src="${escapeHtml(mediaUrl)}" type="video/mp4">
                            Seu navegador n√£o suporta v√≠deo.
                        </video>
                    </div>`;
                    if (msg.body && msg.body.trim()) {
                        html += `<div class="message-caption">${escapeHtml(msg.body)}</div>`;
                    }
                    return html;
                }
                return 'üé• V√≠deo';
            }
            if (msg.type === 'audio' || msg.type === 'ptt') {
                // Retorna HTML para player de √°udio
                const mediaUrl = getMediaUrl(msg);
                if (mediaUrl) {
                    let html = `<div class="message-audio">
                        <span class="audio-icon">üé§</span>
                        <div class="audio-player">
                            <audio controls preload="metadata">
                                <source src="${escapeHtml(mediaUrl)}" type="audio/ogg; codecs=opus">
                                <source src="${escapeHtml(mediaUrl)}" type="audio/mpeg">
                                Seu navegador n√£o suporta √°udio.
                            </audio>
                        </div>
                    </div>`;
                    if (msg.body && msg.body.trim()) {
                        html += `<div class="message-caption">${escapeHtml(msg.body)}</div>`;
                    }
                    return html;
                }
                return 'üé§ √Åudio';
            }
            if (msg.type === 'document') {
                const mediaUrl = getMediaUrl(msg);
                if (mediaUrl) {
                    return `<div class="message-media">
                        <a href="${escapeHtml(mediaUrl)}" target="_blank" style="color: inherit; text-decoration: none;">
                            üìÑ Documento
                        </a>
                        ${msg.body ? `<div class="message-caption">${escapeHtml(msg.body)}</div>` : ''}
                    </div>`;
                }
                return 'üìÑ Documento';
            }
            if (msg.type === 'location') {
                return 'üìç Localiza√ß√£o';
            }
            if (msg.type === 'contact' || msg.type === 'vcard') {
                // Se tem contactName do servidor, usa ele
                if (msg.contactName) {
                    return `üë§ <strong>${escapeHtml(msg.contactName)}</strong>`;
                }
                // Se n√£o tem, tenta extrair do body (vCard)
                if (msg.body && (msg.body.includes('BEGIN:VCARD') || msg.body.includes('VERSION:3.0'))) {
                    try {
                        const fnMatch = msg.body.match(/FN:([^\n\r;]+)/);
                        const nMatch = msg.body.match(/N:([^\n\r;]+)/);
                        const name = fnMatch ? fnMatch[1].trim() : (nMatch ? nMatch[1].split(';')[0].trim() : 'Contato');
                        return `üë§ <strong>${escapeHtml(name)}</strong>`;
                    } catch (e) {
                        return 'üë§ Contato compartilhado';
                    }
                }
                return 'üë§ Contato compartilhado';
            }
            
            // Se n√£o tem body, retorna mensagem padr√£o
            if (!msg.body || !msg.body.trim()) {
                if (msg.hasMedia) {
                    return 'üìé M√≠dia';
                }
                return '(Mensagem sem texto)';
            }
            
            let body = msg.body;
            
            // Detecta e formata vCard (mesmo que n√£o seja tipo contact)
            if (body.includes('BEGIN:VCARD') || body.includes('VERSION:3.0')) {
                try {
                    // Extrai nome
                    const fnMatch = body.match(/FN:([^\n\r;]+)/);
                    const nMatch = body.match(/N:([^\n\r;]+)/);
                    const name = fnMatch ? fnMatch[1].trim() : (nMatch ? nMatch[1].split(';')[0].trim() : 'Contato');
                    
                    // Extrai telefone
                    const telMatch = body.match(/TEL[^:]*:([^\n\r;]+)/);
                    const phone = telMatch ? telMatch[1].trim().replace(/[^\d+]/g, '') : '';
                    
                    // Extrai nome do neg√≥cio se houver
                    const bizMatch = body.match(/X-WA-BIZ-NAME:([^\n\r;]+)/);
                    const bizName = bizMatch ? bizMatch[1].trim() : '';
                    
                    let result = `üë§ <strong>${escapeHtml(name)}</strong>`;
                    if (bizName) {
                        result += `<br><small>${escapeHtml(bizName)}</small>`;
                    }
                    if (phone) {
                        result += `<br>üì± ${escapeHtml(phone)}`;
                    }
                    return result;
                } catch (e) {
                    console.error('Erro ao parsear vCard:', e);
                    return 'üë§ Contato compartilhado';
                }
            }
            
            // Remove caracteres de controle e formata
            body = body.replace(/\x00/g, '').replace(/\r\n/g, '\n').trim();
            
            // Se est√° vazio ap√≥s limpeza
            if (!body) {
                return '(Mensagem sem texto)';
            }
            
            // Limita tamanho muito grande (pode ser spam ou erro)
            if (body.length > 5000) {
                return escapeHtml(body.substring(0, 5000)) + '...<br><small>(Mensagem truncada)</small>';
            }
            
            return escapeHtml(body);
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Vari√°vel para armazenar porta do WhatsApp
        let whatsappServerPort = 5001;
        let whatsappServerUrl = null;
        
        // Fun√ß√£o para obter URL da m√≠dia
        function getMediaUrl(msg) {
            if (!msg.hasMedia || !msg.messageId) {
                return null;
            }
            
            // Usa a URL do servidor WhatsApp se dispon√≠vel, sen√£o constr√≥i a partir da porta
            let baseUrl;
            if (whatsappServerUrl) {
                baseUrl = whatsappServerUrl;
            } else {
                // Em desenvolvimento, usa localhost com porta
                const origin = window.location.origin;
                if (origin.includes('localhost') || origin.includes('127.0.0.1')) {
                    baseUrl = `http://localhost:${whatsappServerPort}`;
                } else {
                    // Em produ√ß√£o, tenta usar o mesmo dom√≠nio
                    baseUrl = origin.replace(/:\d+$/, '') + `:${whatsappServerPort}`;
                }
            }
            
            // Obt√©m user_id para passar na query
            const userId = getCurrentUserId();
            const mediaUrl = `${baseUrl}/media/${msg.messageId}?user_id=${encodeURIComponent(userId)}`;
            
            return mediaUrl;
        }
        
        // Fun√ß√£o auxiliar para obter user_id atual (mesma l√≥gica do backend)
        function getCurrentUserId() {
            // O backend usa get_instance_user_id que retorna: f"{user_id}_{instance_id}" (ex: "2_1")
            if (currentInstanceId) {
                // Em produ√ß√£o, precisaria obter user_id do contexto de autentica√ß√£o
                // Por enquanto, usa padr√£o baseado na inst√¢ncia (assume user_id=1)
                return `1_${currentInstanceId}`;
            }
            // Fallback: usa porta (modo compatibilidade)
            return `port_${whatsappServerPort}`;
        }
        
        // Atualiza informa√ß√µes do servidor WhatsApp ao carregar conversas
        async function updateWhatsAppServerInfo() {
            try {
                const response = await fetch('/api/instances');
                const data = await response.json();
                if (data.success && data.instances && data.instances.length > 0) {
                    const instance = data.instances[0];
                    whatsappServerPort = instance.port || 5001;
                    // Em produ√ß√£o, pode ter URL completa configurada
                    // Por enquanto, usa porta
                }
            } catch (error) {
                console.error('Erro ao obter informa√ß√µes do servidor WhatsApp:', error);
            }
        }
        
        // Fun√ß√£o para abrir imagem em modal
        function openImageModal(imageUrl) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modalImg.src = imageUrl;
            modal.classList.add('active');
        }
        
        // Fun√ß√£o para fechar modal
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
        }
        
        // Fecha modal ao pressionar ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeImageModal();
            }
        });
        
        function renderMessages(messages) {
            const messagesList = document.getElementById('messagesList');
            
            if (messages.length === 0) {
                messagesList.innerHTML = `
                    <div class="empty-state">
                        <h3>üì≠ Nenhuma mensagem</h3>
                    </div>
                `;
                return;
            }
            
            messagesList.innerHTML = messages.map(msg => {
                // Trata timestamp (pode vir em segundos ou milissegundos)
                let timestamp = msg.timestamp;
                if (timestamp < 10000000000) {
                    // Se for menor que isso, provavelmente est√° em segundos
                    timestamp = timestamp * 1000;
                }
                const date = new Date(timestamp);
                const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const isSent = msg.fromMe;
                const body = formatMessageBody(msg);
                
                return `
                    <div class="message-item ${isSent ? 'sent' : 'received'}">
                        <div class="message-bubble">${body}</div>
                        <div class="message-time">${timeStr}</div>
                    </div>
                `;
            }).join('');
            
            // Scroll para o final
            setTimeout(() => {
                messagesList.scrollTop = messagesList.scrollHeight;
            }, 100);
        }
        
        // Atualiza informa√ß√µes do servidor WhatsApp
        updateWhatsAppServerInfo();
        
        // Carrega conversas ao iniciar
        loadConversations();
        
        // Fun√ß√£o para enviar mensagem
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !selectedChatPhone) {
                return;
            }
            
            // Desabilita bot√£o
            const sendBtn = document.getElementById('sendButton');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span>‚è≥</span>';
            
            // Envia mensagem
            fetch('/api/conversations/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    phone: selectedChatPhone,
                    message: message
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // Limpa input
                    input.value = '';
                    input.style.height = 'auto';
                    
                    // Recarrega mensagens para mostrar a enviada
                    setTimeout(() => {
                        loadMessages(selectedChatId);
                    }, 500);
                } else {
                    alert('Erro ao enviar mensagem: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro ao enviar mensagem:', error);
                alert('Erro ao enviar mensagem. Tente novamente.');
            })
            .finally(() => {
                // Reabilita bot√£o
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<span>‚û§</span>';
            });
        }
        
        // Fun√ß√£o para lidar com Enter no input
        function handleMessageKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        // Auto-resize do textarea
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('messageInput');
            if (input) {
                input.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });
            }
        });
        
        // Verifica fluxo ativo
        function checkActiveFlow(phone) {
            fetch(`/api/flows/check?phone=${encodeURIComponent(phone)}`)
                .then(r => r.json())
                .then(data => {
                    const flowStatus = document.getElementById('flowStatus');
                    if (data.success && data.flow) {
                        flowStatus.style.display = 'block';
                        document.getElementById('activeFlowName').textContent = data.flow.name || 'Fluxo ativo';
                    } else {
                        flowStatus.style.display = 'none';
                    }
                })
                .catch(err => {
                    console.error('Erro ao verificar fluxo:', err);
                });
        }
        
        // Atualiza conversas automaticamente a cada 5 segundos (para ver mensagens novas rapidamente)
        setInterval(() => {
            loadConversations();
        }, 5000);
        
        // Atualiza mensagens da conversa ativa a cada 3 segundos
        setInterval(() => {
            if (selectedChatId) {
                loadMessages(selectedChatId);
            }
        }, 3000);
    </script>
{% endblock %}
